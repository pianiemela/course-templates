<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name=viewport content="width=device-width,initial-scale=1">
  <title>GeoGebra</title>
  <script src="https://cdn.geogebra.org/apps/deployggb.js"></script>
  <script>


    function replaceAll(str, find, replace) {
      return str.replace(new RegExp(find, 'g'), replace);
    }

    function parseData(data) {
      var parts = data.split("\n");
      var cmd = parts[0];
      var par="";
      if (parts.length>1)
        par = parts[1];
      console.log(cmd, par);
      return [cmd, par];

    }

    window.onmessage = function (e) {
      // cmd and par as global variables
      console.log("onmessage: ",e.data);

      var ggbData = parseData(e.data);

      console.log(ggbData);

      cmd = ggbData[0];
      cmd = replaceAll(cmd, ";", " \n ");
      par = ggbData[1];
      //cmd = e.data.substring(4);

      var params = {};
      if (par !== "") {
        try{
          par = par.replace("'","");
          params = JSON.parse(par);
        }catch(exp){console.log(exp);}
      }
      //        params = {"appName": "graphing", "allowStyleBar": false, "showToolBar": true, "showAlgebraInput": true, "showMenuBar": true};

      params["language"] = "fi";
      params["width"] = window.innerWidth;
      params["height"] = window.innerHeight;
      params["appletOnLoad"] = initCommands;

      initApplet(params);
    };

    function initCommands() {
      ggbApplet.evalCommand(cmd);
      function addListener() {
        var o_str = "";
        var names = ggbApplet.getAllObjectNames();
        for (var i = 0, name = ""; i < names.length, name = names[i]; i++) {
          var val_str = ggbApplet.getValueString(name);
          o_str += (val_str + ";");
        }
        parent.postMessage(o_str, "*");
      }
      ggbApplet.registerAddListener(addListener);
      ggbApplet.registerUpdateListener(addListener);
    }

    function initApplet(params) {
      var ggbApplet = new GGBApplet(params, true);
      ggbApplet.inject('ggb-element');
      // window.onload = function () { ggbApplet.inject('ggb-element'); }
    }

  </script>
</head>

<body>
  <div id="ggb-element"></div>
</body>

</html>